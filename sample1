
---
- name: Update standalone-full-ha.xml on JBoss Server
  hosts: jboss_servers
  become: yes
  vars:
    jboss_service: jboss
    jboss_config_path: /opt/jboss/standalone/configuration/standalone-full-ha.xml
    backup_path: /opt/jboss/standalone/configuration/backups
    git_repo_url: "https://your-git-repo-url.git"
    git_branch: "main"
    local_git_clone: "/tmp/jboss_config"

  tasks:
    - name: Ensure backup directory exists
      file:
        path: "{{ backup_path }}"
        state: directory
        mode: '0755'

    - name: Backup existing standalone-full-ha.xml
      copy:
        src: "{{ jboss_config_path }}"
        dest: "{{ backup_path }}/standalone-full-ha.xml-{{ ansible_date_time.iso8601 }}"
        remote_src: yes
        mode: '0644'

    - name: Stop JBoss service
      service:
        name: "{{ jboss_service }}"
        state: stopped

    - name: Clone Git repository
      git:
        repo: "{{ git_repo_url }}"
        dest: "{{ local_git_clone }}"
        version: "{{ git_branch }}"
        force: yes

    - name: Copy the new standalone-full-ha.xml to JBoss config path
      copy:
        src: "{{ local_git_clone }}/standalone-full-ha.xml"
        dest: "{{ jboss_config_path }}"
        remote_src: yes
        mode: '0644'
        backup: yes

    - name: Start JBoss service
      service:
        name: "{{ jboss_service }}"
        state: started

    - name: Clean up local Git clone
      file:
        path: "{{ local_git_clone }}"
        state: absent
