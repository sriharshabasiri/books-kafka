---
- name: Search logs with proper file handling
  hosts: localhost
  vars:
    main_log_path: "/opt/finacle/dfsapp/common/log/"
    error_log_paths:
      - "/opt/finacle/dfsapp/common/log/finint/fcrmmb"
      - "/opt/finacle/dfsapp/common/log/fsb/fsbwebservice"
    
    uuid: ""
    search_date: ""
    max_results: 5

  tasks:
    # Previous tasks (validation, date conversion, etc.) remain the same
    
    - name: Search instrumentation logs for success
      ansible.builtin.shell: |
        set -o pipefail
        output_file="/tmp/success_results.txt"
        > "$output_file"
        
        find {{ main_log_path }} -name "instrumentation*.log*" -exec grep -i "{{ uuid }}" {} + | 
        grep -i "{{ instr_date }}" |
        awk -F, '$4 == "success"' |
        tail -n {{ max_results }} > "$output_file"
        
        if [ ! -s "$output_file" ]; then
          echo "No successful transactions found" > "$output_file"
        fi
      register: success_search
      ignore_errors: yes
      changed_when: false

    - name: Process and display success results
      block:
        - name: Read success results
          ansible.builtin.shell: |
            cat /tmp/success_results.txt
          register: success_output
          changed_when: false

        - name: Show success results
          ansible.builtin.debug:
            msg: |
              SUCCESSFUL TRANSACTIONS:
              {{ success_output.stdout }}
      when: success_search.rc == 0

    # Rest of your playbook...
