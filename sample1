import React, { useState, useEffect } from 'react';
import axios from 'axios';

const CertificateRenewalApp = () => {
  // State for regions, environments, servers, and certificates
  const [regions, setRegions] = useState([]);
  const [selectedRegion, setSelectedRegion] = useState('');
  const [environments, setEnvironments] = useState([]);
  const [selectedEnvironment, setSelectedEnvironment] = useState('');
  const [servers, setServers] = useState([]);
  const [selectedServer, setSelectedServer] = useState('');
  const [certificates, setCertificates] = useState([]);
  const [selectedCertificate, setSelectedCertificate] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [message, setMessage] = useState('');
  const [error, setError] = useState('');

  // Fetch regions on component mount
  useEffect(() => {
    const fetchRegions = async () => {
      try {
        setIsLoading(true);
        const response = await axios.get('/api/regions/');
        setRegions(response.data);
        setIsLoading(false);
      } catch (err) {
        setError('Failed to fetch regions');
        setIsLoading(false);
      }
    };

    fetchRegions();
  }, []);

  // Fetch environments when region is selected
  useEffect(() => {
    if (selectedRegion) {
      const fetchEnvironments = async () => {
        try {
          setIsLoading(true);
          const response = await axios.get(`/api/environments/?region=${selectedRegion}`);
          setEnvironments(response.data);
          setIsLoading(false);
        } catch (err) {
          setError('Failed to fetch environments');
          setIsLoading(false);
        }
      };

      fetchEnvironments();
    }
  }, [selectedRegion]);

  // Fetch servers when environment is selected
  useEffect(() => {
    if (selectedEnvironment) {
      const fetchServers = async () => {
        try {
          setIsLoading(true);
          const response = await axios.get(`/api/servers/?environment=${selectedEnvironment}`);
          setServers(response.data);
          setIsLoading(false);
        } catch (err) {
          setError('Failed to fetch servers');
          setIsLoading(false);
        }
      };

      fetchServers();
    }
  }, [selectedEnvironment]);

  // Fetch certificates when server is selected
  useEffect(() => {
    if (selectedServer) {
      const fetchCertificates = async () => {
        try {
          setIsLoading(true);
          const response = await axios.get(`/api/certificates/?server=${selectedServer}`);
          setCertificates(response.data);
          setIsLoading(false);
        } catch (err) {
          setError('Failed to fetch certificates');
          setIsLoading(false);
        }
      };

      fetchCertificates();
    }
  }, [selectedServer]);

  // Handle certificate renewal
  const handleRenewCertificate = async () => {
    if (!selectedCertificate) {
      setError('Please select a certificate to renew');
      return;
    }

    try {
      setIsLoading(true);
      setMessage('');
      setError('');
      
      const response = await axios.post('/api/renew-certificate/', {
        certificate_id: selectedCertificate.id,
        server: selectedServer,
        environment: selectedEnvironment,
        region: selectedRegion
      });

      setMessage(response.data.message || 'Certificate renewal process initiated successfully');
      setIsLoading(false);
      
      // Refresh certificates list
      const certsResponse = await axios.get(`/api/certificates/?server=${selectedServer}`);
      setCertificates(certsResponse.data);
    } catch (err) {
      setError(err.response?.data?.error || 'Failed to initiate certificate renewal');
      setIsLoading(false);
    }
  };

  return (
    <div className="container mt-5">
      <h2 className="mb-4">Certificate Renewal Portal</h2>
      
      {error && <div className="alert alert-danger">{error}</div>}
      {message && <div className="alert alert-success">{message}</div>}
      
      <div className="card mb-4">
        <div className="card-body">
          <h5 className="card-title">Select Certificate to Renew</h5>
          
          {/* Region Selection */}
          <div className="mb-3">
            <label htmlFor="regionSelect" className="form-label">Region</label>
            <select 
              id="regionSelect" 
              className="form-select" 
              value={selectedRegion} 
              onChange={(e) => {
                setSelectedRegion(e.target.value);
                setSelectedEnvironment('');
                setSelectedServer('');
                setCertificates([]);
              }}
              disabled={isLoading}
            >
              <option value="">Select a region</option>
              {regions.map(region => (
                <option key={region.id} value={region.id}>{region.name}</option>
              ))}
            </select>
          </div>
          
          {/* Environment Selection */}
          <div className="mb-3">
            <label htmlFor="envSelect" className="form-label">Environment</label>
            <select 
              id="envSelect" 
              className="form-select" 
              value={selectedEnvironment} 
              onChange={(e) => {
                setSelectedEnvironment(e.target.value);
                setSelectedServer('');
                setCertificates([]);
              }}
              disabled={!selectedRegion || isLoading}
            >
              <option value="">Select an environment</option>
              {environments.map(env => (
                <option key={env.id} value={env.id}>{env.name}</option>
              ))}
            </select>
          </div>
          
          {/* Server Selection */}
          <div className="mb-3">
            <label htmlFor="serverSelect" className="form-label">Server</label>
            <select 
              id="serverSelect" 
              className="form-select" 
              value={selectedServer} 
              onChange={(e) => {
                setSelectedServer(e.target.value);
                setCertificates([]);
              }}
              disabled={!selectedEnvironment || isLoading}
            >
              <option value="">Select a server</option>
              {servers.map(server => (
                <option key={server.id} value={server.id}>{server.name}</option>
              ))}
            </select>
          </div>
        </div>
      </div>
      
      {/* Certificates List */}
      {selectedServer && (
        <div className="card">
          <div className="card-body">
            <h5 className="card-title">Certificates on {servers.find(s => s.id === selectedServer)?.name}</h5>
            
            {isLoading ? (
              <div className="text-center">
                <div className="spinner-border" role="status">
                  <span className="visually-hidden">Loading...</span>
                </div>
              </div>
            ) : (
              <div className="table-responsive">
                <table className="table table-hover">
                  <thead>
                    <tr>
                      <th>Select</th>
                      <th>Alias</th>
                      <th>Issuer</th>
                      <th>Subject</th>
                      <th>Expiry Date</th>
                      <th>Days Remaining</th>
                    </tr>
                  </thead>
                  <tbody>
                    {certificates.length > 0 ? (
                      certificates.map(cert => (
                        <tr key={cert.id} className={cert.days_remaining < 30 ? 'table-warning' : ''}>
                          <td>
                            <input 
                              type="radio" 
                              name="certificate" 
                              checked={selectedCertificate?.id === cert.id}
                              onChange={() => setSelectedCertificate(cert)}
                            />
                          </td>
                          <td>{cert.alias}</td>
                          <td>{cert.issuer}</td>
                          <td>{cert.subject}</td>
                          <td>{cert.expiry_date}</td>
                          <td>
                            <span className={cert.days_remaining < 30 ? 'text-danger fw-bold' : ''}>
                              {cert.days_remaining}
                            </span>
                          </td>
                        </tr>
                      ))
                    ) : (
                      <tr>
                        <td colSpan="6" className="text-center">No certificates found</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            )}
            
            <div className="d-flex justify-content-end mt-3">
              <button 
                className="btn btn-primary" 
                onClick={handleRenewCertificate}
                disabled={!selectedCertificate || isLoading}
              >
                {isLoading ? (
                  <span className="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                ) : (
                  'Renew Selected Certificate'
                )}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default CertificateRenewalApp;
